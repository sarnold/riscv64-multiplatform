From e137fae33b1eb3a2469c666a48c42cbda5adbbf5 Mon Sep 17 00:00:00 2001
From: Tom <support@vamrs.com>
Date: Mon, 11 Jan 2021 00:43:19 +0800
Subject: [PATCH 60/86] Improve stmmac data cache flush [v0.9->v1.0]

---
 drivers/net/ethernet/stmicro/stmmac/stmmac_main.c | 9 +++++++++
 1 file changed, 9 insertions(+)

diff --git a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
index 427b4718ffe4..d2fa6436bab2 100644
--- a/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
+++ b/drivers/net/ethernet/stmicro/stmmac/stmmac_main.c
@@ -4061,6 +4061,9 @@ static int stmmac_rx(struct stmmac_priv *priv, int limit, u32 queue)
 
 			dma_sync_single_for_cpu(priv->device, buf->addr,
 						buf1_len, DMA_FROM_DEVICE);
+#ifdef FLUSH_RX_BUF_ENABLE
+				stmmac_flush_dcache(buf->addr, buf1_len);
+#endif
 			skb_copy_to_linear_data(skb, page_address(buf->page),
 						buf1_len);
 			skb_put(skb, buf1_len);
@@ -4071,6 +4074,9 @@ static int stmmac_rx(struct stmmac_priv *priv, int limit, u32 queue)
 		} else if (buf1_len) {
 			dma_sync_single_for_cpu(priv->device, buf->addr,
 						buf1_len, DMA_FROM_DEVICE);
+#ifdef FLUSH_RX_BUF_ENABLE
+				stmmac_flush_dcache(buf->addr, buf1_len);
+#endif
 			skb_add_rx_frag(skb, skb_shinfo(skb)->nr_frags,
 					buf->page, 0, buf1_len,
 					priv->dma_buf_sz);
@@ -4083,6 +4089,9 @@ static int stmmac_rx(struct stmmac_priv *priv, int limit, u32 queue)
 		if (buf2_len) {
 			dma_sync_single_for_cpu(priv->device, buf->sec_addr,
 						buf2_len, DMA_FROM_DEVICE);
+#ifdef FLUSH_RX_BUF_ENABLE
+				stmmac_flush_dcache(buf->sec_addr, buf2_len);
+#endif
 			skb_add_rx_frag(skb, skb_shinfo(skb)->nr_frags,
 					buf->sec_page, 0, buf2_len,
 					priv->dma_buf_sz);
-- 
2.30.0

